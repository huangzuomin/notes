<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åª’ä½“äººAIé©±åŠ¨åŠ›æŒ‡æ•° (MADI) äº‘ç«¯æ•°æ®ç‰ˆ V4.0</title>
    
    <!-- 1. æ ¸å¿ƒä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- æ–°å¢: Supabase å®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary: #003366; --accent: #D4AF37; --bg: #F5F7FA; --white: #fff; --radius: 12px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "PingFang SC", system-ui, sans-serif; background: var(--bg); color: #333; line-height: 1.6; }
        
        .container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: var(--white); position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .screen { padding: 30px 20px; display: none; opacity: 0; transition: opacity 0.4s ease; }
        .screen.active { display: block; opacity: 1; }

        /* ç»„ä»¶æ ·å¼ */
        .btn { display: block; width: 100%; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center; cursor: pointer; border: none; transition: 0.2s; margin-top: 15px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-loading { opacity: 0.7; cursor: not-allowed; }
        
        .progress-track { height: 6px; background: #eee; border-radius: 3px; position: relative; margin: 20px 10px 40px 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; border-radius: 3px; transition: width 0.5s; }
        .progress-car { position: absolute; top: -14px; left: 0%; transform: translateX(-50%); font-size: 24px; transition: left 0.5s; }

        .q-card { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .q-tag { background: #E6F0FA; color: var(--primary); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .q-text { font-size: 18px; font-weight: 700; margin-bottom: 25px; }

        .likert-options { display: flex; gap: 8px; }
        .likert-btn { flex: 1; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 12px 4px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .likert-btn.selected { border-color: var(--accent); background: #FFFDF5; color: var(--accent); font-weight: bold; transform: translateY(-2px); }

        .report-header { background: var(--primary); color: white; padding: 40px 20px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .gate-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 24px; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .form-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 999; display: none; }

        @media (max-width: 480px) {
            .likert-options { flex-direction: column; gap: 10px; }
            .likert-btn { display: flex; align-items: center; padding: 12px 15px; text-align: left; }
            .likert-btn::before { content: attr(data-val); width: 28px; height: 28px; background: #f5f5f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold; color: #666; font-size: 12px; }
            .likert-btn.selected::before { background: var(--accent); color: white; }
        }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="container">
    <!-- 1. æ¬¢è¿é¡µ -->
    <div id="screen-welcome" class="screen active">
        <div style="text-align: center; padding-top: 40px;">
            <h1 style="color:var(--primary); margin: 10px 0;">MADI åª’ä½“AIæŒ‡æ•°</h1>
            <p style="color: #666; font-size: 14px;">V4.0 äº‘ç«¯æ•°æ®å®æˆ˜ç‰ˆ</p>
            
            <div style="background: #F8F9FA; padding: 20px; border-radius: 12px; text-align: left; margin-top: 30px;">
                <label style="font-weight: bold; display:block; margin-bottom:10px;">é€‰æ‹©æ‚¨çš„æ ¸å¿ƒå²—ä½ï¼š</label>
                <select id="role-selector" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size:16px; background:white;">
                    <option value="reporter">âœï¸ è®°è€…/æ·±åº¦é‡‡ç¼–</option>
                    <option value="video">ğŸ¬ è§†é¢‘/è§†å¬åˆ¶ä½œ</option>
                    <option value="manager">ğŸ’¼ ç®¡ç†è€…/ä¸»ç¼–</option>
                    <option value="editor">ğŸ›¡ï¸ ç¼–è¾‘/å®¡æ ¸</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="startAssessment()">å¼€å§‹æµ‹è¯„</button>
        </div>
    </div>

    <!-- 2. ç­”é¢˜é¡µ -->
    <div id="screen-quiz" class="screen">
        <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
            <div class="progress-car" id="progress-car">ğŸš—</div>
        </div>
        <div id="question-container"></div>
    </div>

    <!-- 3. æŠ¥å‘Šé¡µ -->
    <div id="screen-report" class="screen" style="padding:0;">
        <div class="report-header">
            <div style="font-size:14px; opacity:0.9;" id="rpt-role">å²—ä½</div>
            <div style="font-size: 48px; font-weight: 800; color: var(--accent);" id="rpt-score">0</div>
            <div style="font-size: 20px; font-weight: bold;" id="rpt-level">LV0</div>
        </div>

        <div style="padding: 20px;">
            <!-- é›·è¾¾å›¾ -->
            <div style="height: 250px; position: relative;">
                <canvas id="radarChart"></canvas>
            </div>

            <!-- é”å®šè¡¨å• (æ•°æ®ä¸Šä¼ ç‚¹) -->
            <div class="gate-card" id="lead-gate">
                <h3 style="color:var(--primary); margin-bottom:10px;">ğŸ“¥ ä¿å­˜ç»“æœå¹¶è§£é”å»ºè®®</h3>
                <p style="font-size:13px; color:#666; margin-bottom:15px;">æˆ‘ä»¬å°†ä¸ºæ‚¨å»ºç«‹ä¸“å±æ¡£æ¡ˆï¼Œå¹¶æä¾›åŒå²—ä½çš„å®æ—¶æ•°æ®å¯¹æ¯”ã€‚</p>
                
                <form id="lead-form" onsubmit="handleSubmit(event)">
                    <input type="text" id="lead-name" class="form-input" placeholder="æ‚¨çš„å§“å" required>
                    <input type="text" id="lead-company" class="form-input" placeholder="æ‰€å±åª’ä½“æœºæ„" required>
                    <input type="tel" id="lead-phone" class="form-input" placeholder="è”ç³»ç”µè¯ (ç”¨äºæ‰¾å›æ¡£æ¡ˆ)" required pattern="[0-9]{11}">
                    <button type="submit" class="btn btn-primary" id="submit-btn">æäº¤å¹¶è§£é”å®Œæ•´æŠ¥å‘Š</button>
                </form>
                <p style="font-size:12px; color:#999; margin-top:10px;">ğŸ”’ æ•°æ®å·²é€šè¿‡ SSL åŠ å¯†å­˜å‚¨è‡³äº‘ç«¯æ•°æ®åº“</p>
            </div>

            <!-- è§£é”åçš„å†…å®¹ -->
            <div id="locked-content" style="display: none; margin-top: 20px;">
                <div style="background:#F0F8FF; padding:15px; border-radius:8px; border-left:4px solid var(--primary); margin-bottom:20px;">
                    <h4 style="color:var(--primary);">ğŸ“Œ æ™ºèƒ½è¯Šæ–­</h4>
                    <p style="font-size:14px; color:#555; margin-top:5px;" id="rpt-advice">...</p>
                </div>
                <button class="btn btn-outline" style="border:1px solid var(--primary); color:var(--primary); background:white;" onclick="generatePoster()">ğŸ“¸ ç”Ÿæˆè£èª‰æµ·æŠ¥</button>
            </div>
        </div>
    </div>
</div>

<script>
/* ================= 0. Supabase é…ç½® (è¯·æ›¿æ¢æ­¤å¤„!) ================= */
// ğŸ”´ è¯·å°†ä¸‹é¢çš„ URL å’Œ KEY æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ Supabase é¡¹ç›®å‡­è¯
const SUPABASE_URL = 'https://dhmbtfkzilgbvcroosyr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRobWJ0Zmt6aWxnYnZjcm9vc3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjcxNDMsImV4cCI6MjA3MjQwMzE0M30.YxqjGDN65zuRYkKLS1bUeFJGnEenafzjOMneSl-GpIE';

// åˆå§‹åŒ–å®¢æˆ·ç«¯
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= 1. é¢˜åº“æ•°æ® ================= */
const Q_DATA = {
    common: [
        { id: "C1", dim: "ethics", text: "æˆ‘ç»ä¸å°†æœªè„±æ•çš„å†…éƒ¨æ•æ„Ÿæ•°æ®ä¸Šä¼ è‡³å…¬ç½‘AIæ¨¡å‹ã€‚", type: "likert" },
        { id: "C2", dim: "tools", text: "é‡åˆ°é—®é¢˜æ—¶ï¼Œæˆ‘çš„ç¬¬ä¸€ååº”æ˜¯é—®AIï¼Œè€Œä¸æ˜¯ç™¾åº¦ã€‚", type: "likert" }
    ],
    reporter: [
        { id: "R1", dim: "tools", text: "æˆ‘èƒ½ç”¨AIå¤„ç†é•¿å½•éŸ³ï¼Œæå–æ‘˜è¦å’Œé‡‘å¥ã€‚", type: "likert" },
        { id: "R2", dim: "prompt", text: "æˆ‘ä¼šä½¿ç”¨ç»“æ„åŒ–æç¤ºè¯(è§’è‰²+ä»»åŠ¡)æ¥æé—®ã€‚", type: "likert" },
        { id: "R3", dim: "ethics", text: "å¯¹äºAIç»™å‡ºçš„äº‹å®ï¼Œæˆ‘ä¼šè¿›è¡ŒåŒæºéªŒè¯ã€‚", type: "likert" }
    ],
    video: [
        { id: "V1", dim: "innovate", text: "æˆ‘èƒ½é€šè¿‡Seedå€¼æ§åˆ¶AIç”Ÿæˆç”»é¢çš„ä¸€è‡´æ€§ã€‚", type: "likert" },
        { id: "V2", dim: "tools", text: "æˆ‘å°è¯•è¿‡å›¾ç”Ÿè§†é¢‘(Image-to-Video)å·¥å…·ã€‚", type: "likert" }
    ],
    manager: [
        { id: "M1", dim: "collab", text: "æˆ‘å»ºç«‹äº†å›¢é˜Ÿå…±äº«çš„Promptåº“ã€‚", type: "likert" },
        { id: "M2", dim: "ethics", text: "æˆ‘æœ‰æ˜ç¡®çš„AIä½¿ç”¨åˆè§„ä¸å…è´£æœºåˆ¶ã€‚", type: "likert" }
    ],
    editor: [ { id: "E1", dim: "ethics", text: "æˆ‘ä¼šæ£€æŸ¥ç¨¿ä»¶çš„AIå«é‡‘é‡å¹¶è¿›è¡Œæ ‡æ³¨ã€‚", type: "likert" } ]
};

const BENCHMARKS = {
    reporter: { tools:60, prompt:55, collab:40, innovate:30, ethics:70 },
    video:    { tools:75, prompt:60, collab:50, innovate:65, ethics:40 },
    manager:  { tools:40, prompt:50, collab:75, innovate:60, ethics:80 },
    editor:   { tools:50, prompt:50, collab:60, innovate:40, ethics:85 }
};

/* ================= 2. ä¸šåŠ¡çŠ¶æ€ ================= */
let state = { role: '', qs: [], idx: 0, answers: {}, qStart: 0, finalScores: null, finalTotal: 0 };

// å¼€å§‹æµ‹è¯„
function startAssessment() {
    state.role = document.getElementById('role-selector').value;
    state.qs = [...Q_DATA.common, ...(Q_DATA[state.role] || Q_DATA.reporter)];
    state.idx = 0;
    document.getElementById('screen-welcome').classList.remove('active');
    document.getElementById('screen-quiz').classList.add('active');
    renderQuestion();
}

// æ¸²æŸ“é¢˜ç›®
function renderQuestion() {
    state.qStart = Date.now();
    const q = state.qs[state.idx];
    const pct = ((state.idx) / state.qs.length) * 100;
    
    document.getElementById('progress-fill').style.width = pct + '%';
    document.getElementById('progress-car').style.left = pct + '%';

    const html = `
        <div class="q-card">
            <span class="q-tag">${getDimName(q.dim)}</span>
            <div class="q-text">${state.idx+1}. ${q.text}</div>
            <div class="likert-options">
                ${[1,2,3,4,5].map(v => `
                    <div class="likert-btn" data-val="${v}" onclick="handleAnswer(${v}, '${q.id}', this)">
                        <div style="font-size:12px;">${getLikertLabel(v)}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    document.getElementById('question-container').innerHTML = html;
}

// å¤„ç†ä½œç­”
function handleAnswer(val, id, el) {
    if (Date.now() - state.qStart < 1000) { showToast("ğŸš— è½¦é€Ÿå¤ªå¿«ï¼Œè¯·çœ‹æ¸…é¢˜ç›®"); return; }
    
    document.querySelectorAll('.likert-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    state.answers[id] = val;

    setTimeout(() => {
        if (state.idx < state.qs.length - 1) {
            state.idx++;
            renderQuestion();
        } else {
            calculateResult();
        }
    }, 300);
}

// è®¡ç®—ç»“æœï¼ˆæš‚ä¸ä¸Šä¼ ï¼Œç­‰å¾…è¡¨å•ï¼‰
function calculateResult() {
    const scores = { tools:[], prompt:[], collab:[], innovate:[], ethics:[] };
    state.qs.forEach(q => { if (scores[q.dim]) scores[q.dim].push(state.answers[q.id]||0); });
    
    let userScore = {};
    let total = 0;
    for(let k in scores) {
        const arr = scores[k];
        userScore[k] = arr.length ? Math.round((arr.reduce((a,b)=>a+b,0)/(arr.length*5))*100) : 0;
        total += userScore[k];
    }
    state.finalScores = userScore;
    state.finalTotal = Math.round(total / 5);

    // åˆ‡æ¢åˆ°æŠ¥å‘Šé¡µ
    document.getElementById('screen-quiz').classList.remove('active');
    document.getElementById('screen-report').classList.add('active');
    
    // å¡«å……åŸºç¡€æ•°æ®
    document.getElementById('rpt-role').innerText = document.getElementById('role-selector').selectedOptions[0].text;
    document.getElementById('rpt-score').innerText = state.finalTotal;
    document.getElementById('rpt-level').innerText = getLevel(state.finalTotal);
    
    // ç»˜åˆ¶é›·è¾¾å›¾
    renderRadar(state.finalScores, BENCHMARKS[state.role]);
}

/* ================= 3. Supabase æ•°æ®æäº¤é€»è¾‘ ================= */
async function handleSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    const originalText = btn.innerText;
    
    // UI çŠ¶æ€æ›´æ–°
    btn.innerText = "æ­£åœ¨åŠ å¯†ä¸Šä¼ äº‘ç«¯...";
    btn.classList.add('btn-loading');
    btn.disabled = true;

    // æ”¶é›†è¡¨å•æ•°æ®
    const leadData = {
        role: state.role,
        total_score: state.finalTotal,
        dim_scores: state.finalScores,
        lead_name: document.getElementById('lead-name').value,
        lead_company: document.getElementById('lead-company').value,
        lead_phone: document.getElementById('lead-phone').value
    };

    try {
        // âš ï¸ æ ¸å¿ƒï¼šå‘ Supabase æ’å…¥æ•°æ®
        const { data, error } = await supabase
            .from('madi_leads') // ç¡®ä¿è¿™ä¸ªè¡¨åä¸ä½ åœ¨ Supabase åˆ›å»ºçš„ä¸€è‡´
            .insert([ leadData ])
            .select();

        if (error) throw error;

        // æˆåŠŸåé€»è¾‘
        showToast("âœ… æ¡£æ¡ˆå»ºç«‹æˆåŠŸï¼");
        document.getElementById('lead-gate').style.display = 'none';
        document.getElementById('locked-content').style.display = 'block';
        
        // è‡ªåŠ¨ç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®
        generateAdvice();

    } catch (err) {
        console.error("Upload Error:", err);
        // é™çº§å¤„ç†ï¼šå³ä½¿æ•°æ®åº“æŠ¥é”™ï¼Œä¹Ÿè®©ç”¨æˆ·çœ‹ç»“æœï¼Œä»¥å…æµå¤±
        showToast("âš ï¸ ç½‘ç»œè¿æ¥å¾®å¼±ï¼Œä½†å·²ä¸ºæ‚¨è§£é”æœ¬åœ°æŠ¥å‘Š");
        document.getElementById('lead-gate').style.display = 'none';
        document.getElementById('locked-content').style.display = 'block';
        generateAdvice();
    } finally {
        btn.innerText = originalText;
        btn.classList.remove('btn-loading');
        btn.disabled = false;
    }
}

/* ================= 4. è¾…åŠ©ä¸å›¾è¡¨ ================= */
function renderRadar(user, bench) {
    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: ['å·¥å…·','æŒ‡ä»¤','ååŒ','åˆ›æ–°','ä¼¦ç†'],
            datasets: [
                { label:'æˆ‘çš„å¾—åˆ†', data:[user.tools,user.prompt,user.collab,user.innovate,user.ethics], backgroundColor:'rgba(212,175,55,0.2)', borderColor:'#D4AF37' },
                { label:'è¡Œä¸šå¹³å‡', data:[bench.tools,bench.prompt,bench.collab,bench.innovate,bench.ethics], borderColor:'#ccc', borderDash:[5,5], fill:false, pointRadius:0 }
            ]
        },
        options: { scales: { r: { min:0, max:100, ticks:{display:false} } }, plugins: { legend: { position:'bottom' } } }
    });
}

function generateAdvice() {
    const sorted = Object.entries(state.finalScores).sort((a,b)=>a[1]-b[1]);
    const low = sorted[0];
    document.getElementById('rpt-advice').innerText = 
        `ç³»ç»Ÿåˆ†æäº†æ‚¨çš„äº”ç»´æ¨¡å‹ï¼Œå‘ç°æ‚¨åœ¨ [${getDimName(low[0])}] ç»´åº¦ï¼ˆ${low[1]}åˆ†ï¼‰ä¸è¡Œä¸šå¹³å‡æ°´å¹³æœ‰ä¸€å®šå·®è·ã€‚å»ºè®®é‡ç‚¹å¼ºåŒ–è¯¥é¢†åŸŸçš„å·¥å…·é“¾æ•´åˆã€‚`;
}

function generatePoster() {
    showToast("æ­£åœ¨ç”Ÿæˆé«˜æ¸…æµ·æŠ¥...");
    html2canvas(document.getElementById('screen-report')).then(canvas => {
        const link = document.createElement('a');
        link.download = `MADI_${document.getElementById('lead-name').value}.png`;
        link.href = canvas.toDataURL();
        link.click();
    });
}

function getDimName(k) { const m={tools:'å·¥å…·',prompt:'æŒ‡ä»¤',collab:'ååŒ',innovate:'åˆ›æ–°',ethics:'ä¼¦ç†'}; return m[k]; }
function getLikertLabel(v) { return ['','éå¸¸ä¸åŒæ„','ä¸åŒæ„','ä¸€èˆ¬','åŒæ„','éå¸¸åŒæ„'][v]; }
function getLevel(s) { return s<40?'LV1 å¼•æ“é¢„çƒ­': s<60?'LV2 ä¸€æ¡£èµ·æ­¥': s<80?'LV3 å·¡èˆªé©¾é©¶':'LV4 æ™ºèƒ½é¢†èˆª'; }
function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); }

</script>
</body>
</html>
